DOCUMENTAÇÃO DO BACKEND - CryptoVision

Visão Geral
- Stack: FastAPI (Python), integração com Binance, módulo de ML, sentimento de notícias (opcional), cache local e persistência leve.
- Objetivo: expor API para análise de mercado (BTCUSDT), indicadores, previsões de ML, status, ordens abertas, chaves e configuração.

Como Rodar
- Local (dev)
  - Requisitos: Python 3.11+, pip, venv
  - Windows: `python -m venv .venv && .\\.venv\\Scripts\\Activate.ps1`
  - Linux/Mac: `python -m venv .venv && source .venv/bin/activate`
  - `pip install -r requirements.txt`
  - `uvicorn api.app:app --reload --port 8000`
  - Docs interativas: GET /docs (Swagger) e GET /redoc
- Docker
  - `docker compose up -d --build api worker`
  - O serviço `web` exige pasta ./web; se não existir, suba apenas `api` e `worker`
- Produção (exemplo)
  - `uvicorn api.app:app --host 0.0.0.0 --port 8000 --workers 1`
  - Opcional: Nginx/Traefik para TLS/roteamento

Variáveis de Ambiente
- Binance: `BINANCE_API_KEY`, `BINANCE_API_SECRET`
- Notícias (opcional): `CRYPTOPANIC_API_KEY`, `NEWSAPI_KEY`
- CORS: `ALLOW_ORIGINS` (padrão `*`)
- Background: `ENABLE_BACKGROUND_SERVICE` (0/1), `BACKGROUND_INTERVAL`
- Banco/Cripto: `DB_PATH`, `ENCRYPTION_KEY_FILE`, `ENCRYPTION_KEY`

Estrutura Principal (arquivos)
- api/app.py — rotas e lifecycle
- BinanceConnector.py — cliente Binance com cache/circuit breaker
- Market_Analyzer.py — indicadores, ML e decisão
- RiskManager.py — risco e snapshots
- database.py — SQLite (configs, chaves, caches)
- ml_model.py — treino/carregamento modelo
- News_Worker.py — sentimento (opcional)
- cache_manager.py, alert_system.py, Logger.py — utilitários

Fluxo de Dados (resumo)
- Entradas: preços Binance, indicadores (RSI/MACD/SMAs/BB), sentimento (opcional), ML
- Processamento: indicadores + regras + previsões; decisão e confiança
- Saídas: JSON com decisão, confiança, indicadores, previsões, séries para gráfico

Tratamento de Erros e Alertas
- Logs com fallback; circuit breaker no conector
- HTTP 4xx para entrada inválida, 5xx para falhas internas

Segurança
- Não logar segredos. Proteger `/keys`, `/config`, `/sync`, `/analyze`
- Em produção pública, considerar API key/Basic/JWT e rate limit no gateway

Referência da API (JSON)
- GET /status
  - `{ "ok": true, "has_results": bool, "has_keys": bool }`

- GET /summary
  - Sumário recente: `price`, `indicators`, `ml_predictions`, `risk_summary`

- GET /analysis?tf=15m|1h|4h|1d (padrão: 1h)
  - Análise detalhada do timeframe; inclui `series` (close/smas/bb) e `df_tail`

- GET /orders/open?symbol=BTCUSDT
  - Ordens abertas do símbolo

- GET /config
  - `{ "auto_trade_min_confidence": float, "auto_trade_min_ml_score": float, "min_notional": float }`

- POST /config
  - Atualiza os campos acima

- POST /keys
  - `{ "api_key": "...", "api_secret": "..." }`

- POST /analyze
  - Reanálise imediata: `{ "ok": true, "result": { ... } }`

- POST /sync
  - Sincroniza/resumo de conta no RiskManager

Modelos/Campos Importantes
- decision: BUY | SELL | HOLD
- confidence: 0.0–1.0
- indicators: rsi, macd, sma20/50/200, bandas (bb_up/mid/low), atr
- ml_predictions: previsões do(s) modelo(s) carregado(s)
- series: time (ISO), close/sma20/sma50/sma200/bb_up/bb_mid/bb_low
- risk_summary: resumo do RiskManager quando disponível

Exemplos de cURL
- `curl "http://localhost:8000/analysis?tf=1h"`
- `curl -X POST "http://localhost:8000/keys" -H "Content-Type: application/json" -d "{\"api_key\":\"...\",\"api_secret\":\"...\"}"`
- `curl -X POST "http://localhost:8000/analyze"`

Roteiro de Debug
- 500 em endpoints: verifique chaves Binance, conectividade e logs do conector
- `has_keys=false` em `/status`: salve chaves via `/keys` ou configure env vars
- séries vazias: confirme timeframe e rode `/analyze` para preencher resultados

